#!/usr/bin/env python3

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys

request = json.load(sys.stdin)

# write dnsmasq configuration to easy json file, will be used by UI
open("config.json", "w").write(json.dumps(request))

# convert json to configuration file
with open("dnsmasq.d/00config.conf", "w") as file:
    file.write("# This file is automatically generated by NethServer, manual changes will be lost.\n")
    # write interface only if dhcp-server or dns-server are enabled
    if request["dhcp-server"]["enabled"] or request["dns-server"]["enabled"]:
        file.write("interface=" + request["interface"] + "\n")

    # write dhcp-server configuration
    if request["dhcp-server"]["enabled"]:
        file.write("dhcp-range=set:default," + request["dhcp-server"]["start"] + "," + request["dhcp-server"]["end"] + "," + str(request["dhcp-server"]["lease"]) + "h\n")

    # write dns-server configuration
    if request["dns-server"]["enabled"]:
        for server in request["dns-server"]["servers"]:
            file.write("server=" + server + "\n")
    else:
        # shut down dns server if not enabled
        file.write("port=0\n")
